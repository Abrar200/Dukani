{% extends "business/base.html" %}

{% load static %}

{% block slider %}

<div class="breadcrumb-block style-shared">
    <div class="breadcrumb-main bg-linear overflow-hidden">
        <div class="container lg:pt-[134px] pt-24 pb-10 relative">
            <div class="main-content w-full h-full flex flex-col items-center justify-center relative z-[1]">
                <div class="text-content">
                    <div class="heading2 text-center">Checkout</div>
                    <div class="link flex items-center justify-center gap-1 caption1 mt-3">
                        <a href="{% url 'home' %}">Homepage</a>
                        <i class="ph ph-caret-right text-sm text-secondary2"></i>
                        <div class='text-secondary2 capitalize'>Checkout</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock slider %}

{% if messages %}
    <div class="container mt-3">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

{% block content %}

<script src="https://js.stripe.com/v3/"></script>

<div class="checkout-block md:py-20 py-10">
    <div class="container">
        <div class="content-main flex justify-between">
            <div class="left w-1/2">
                <div class="form-login-block mt-3">
                </div>
                <div class="information mt-5">
                    <div class="heading5">Information</div>
                    <div class="form-checkout mt-5">
                        <form id="checkout-form">
                            {% csrf_token %}
                            <div class="grid sm:grid-cols-2 gap-5">
                                <div class="email ">
                                    <input class="border-line px-4 pt-3 pb-3 w-full rounded-lg" id="address" name="address" type="text" placeholder="Address *" required />
                                </div>
                                <div class="email ">
                                    <input class="border-line px-4 pt-3 pb-3 w-full rounded-lg" id="city" name="city" type="text" placeholder="City *" required />
                                </div>
                                <div class="email ">
                                    <input class="border-line px-4 pt-3 pb-3 w-full rounded-lg" id="state" name="state" type="text" placeholder="State *" required />
                                </div>
                                <div class="email ">
                                    <input class="border-line px-4 pt-3 pb-3 w-full rounded-lg" id="postal_code" name="postal_code" type="text" placeholder="Postal Code *" required />
                                </div>
                                <div class="col-span-full">
                                    <textarea class="border border-line px-4 py-3 w-full rounded-lg" id="note" name="note" placeholder="Write note..."></textarea>
                                </div>
                            </div>
                            <div class="payment-block md:mt-10 mt-6">
                                <div class="heading5">Choose payment Option:</div>
                                <div class="list-payment mt-5">
                                    <div class='type bg-surface p-5 border border-line rounded-lg' id="creditCardForm">
                                        <input class="cursor-pointer" type="radio" id="credit" name="payment" />
                                        <label class="text-button pl-2 cursor-pointer" for="credit">Credit Card</label>
                                        <div class="infor">
                                            <!-- Credit Card Info Fields -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="block-button md:mt-10 mt-6">
                                <button type="button" id="checkout-button" class="button-main w-full bg-black text-white whitespace-nowrap">Make Payment</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="right w-5/12">
                <div class="checkout-block">
                    <div class="heading5 pb-3">Your Order</div>
                    <div class="list-product-checkout">
                        {% for item in cart_items %}
                        <div class="item flex items-center justify-between w-full pb-5 border-b border-line gap-6 mt-5">
                            <div style="height: 120px" class="bg-img w-[100px] aspect-square flex-shrink-0 rounded-lg overflow-hidden">
                                <img src="{{ item.product.image.url }}" alt="img" class="w-full h-full">
                            </div>
                            <div class="flex items-center justify-between w-full">
                                <div>
                                    <div class="name text-title">{{ item.product.name }}</div>
                                    <div class="caption1 text-secondary mt-2">
                                        <span class="size capitalize">XS</span>
                                        <span>/</span>
                                        <span class="color capitalize">white</span>
                                    </div>
                                </div>
                                <div class="text-title">
                                    <span class="quantity">{{ item.quantity }}</span>
                                    <span class="px-1">x</span>
                                    <span>${{ item.product.price }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="total-cart-block pt-5 flex justify-between">
                        <div class="heading5">Total</div>
                        <div class="heading5 total-cart">${{ total_price }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const stripe = Stripe("{{ stripe_public_key }}");
    const checkoutButton = document.getElementById("checkout-button");

    checkoutButton.addEventListener("click", function () {
        const formData = new FormData(document.getElementById("checkout-form"));
        const data = {};
        formData.forEach((value, key) => (data[key] = value));
    
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    
        console.log("Form Data:", data);
    
        fetch("{% url 'checkout' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(session => {
            if (session.error) {
                alert(session.error);
            } else {
                return stripe.redirectToCheckout({ sessionId: session.id });
            }
        })
        .then(result => {
            if (result.error) {
                alert(result.error.message);
            }
        })
        .catch(error => {
            console.error("Error:", error);
        });
    });
</script>


{% endblock content %}